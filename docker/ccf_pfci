FROM mcr.microsoft.com/azurelinux/base/core:3.0

RUN gpg --import /etc/pki/rpm-gpg/MICROSOFT-RPM-GPG-KEY
RUN tdnf -y update
RUN tdnf -y install ca-certificates git
RUN tdnf -y install wget tar

RUN tdnf install -y build-essential

ARG CCF_URL=https://github.com/microsoft/CCF/releases/download/ccf-6.0.0-rc1/ccf_snp_6.0.0_rc1_x86_64.rpm

#RUN wget -O /tmp/ccf.rpm $CCF_URL
COPY ./build/ccf_snp_devel_6.0.0~rc1-14-geca2c8f3c_x86_64.rpm /tmp/ccf.rpm
RUN tdnf install -y /tmp/ccf.rpm

# Horrible hacks to make this work
RUN echo "ccf-6.0.0-rc1" > /opt/ccf_snp/share/VERSION_LONG
RUN sed -i 's/{{ snp_endorsements_servers|tojson }},/[ { "type": "AMD", "url": "kdsintf.amd.com"} ],/g' /opt/ccf_snp/bin/config.jinja


CMD ["/opt/ccf_snp/bin/sandbox.sh"]